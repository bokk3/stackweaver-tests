---
# Ansible playbook for installing Elastic Stack on Arch Linux
# Installs Elasticsearch, Logstash, and Kibana from AUR using yay

- name: Install Elastic Stack on Arch Linux
  hosts: all
  gather_facts: false  # Disable initially to allow Python installation if needed
  become: true
  become_method: sudo
  # Note: Requires sudo access. If sysadmin has passwordless sudo (NOPASSWD),
  # configure ansible_become_password="" in inventory. Otherwise provide password.
  
  vars:
    elasticsearch_version: "8"  # Optional: specify version or use latest
    logstash_version: "8"        # Optional: specify version or use latest
    kibana_version: "8"          # Optional: specify version or use latest
    aur_user: "aur"              # User to use for AUR builds (non-root)
    
  pre_tasks:
    # Ensure Python is installed (raw module doesn't require Python on target)
    # Check if Python exists - doesn't need sudo
    - name: Check if Python is available
      ansible.builtin.raw: command -v python || command -v python3 || echo "NOT_FOUND"
      register: python_check
      changed_when: false
      failed_when: false
      become: false  # This check doesn't need sudo
      
    # Install Python if needed
    # Note: This requires sudo password or passwordless sudo (NOPASSWD)
    # If sudo requires password, ensure ansible_become_password is set in inventory
    # or configure passwordless sudo on the target host
    - name: Install Python if not found
      ansible.builtin.raw: pacman -Sy --noconfirm python
      when: "'NOT_FOUND' in python_check.stdout"
      changed_when: "'NOT_FOUND' in python_check.stdout"
      become: true  # Use Ansible's become mechanism
      become_method: sudo
      register: python_install
      
    - name: Display Python installation result
      ansible.builtin.debug:
        msg: |
          Python check result: {{ python_check.stdout }}
          {% if python_check.stdout == 'NOT_FOUND' %}
          Python was installed successfully (exit code: {{ python_install.rc | default('N/A') }})
          {% else %}
          Python already available
          {% endif %}
      
    # Verify Python is now available
    - name: Verify Python installation
      ansible.builtin.raw: command -v python || command -v python3
      register: python_verify
      changed_when: false
      become: false
      
    # Gather facts after Python is available
    - name: Gather facts after Python is available
      ansible.builtin.setup:
      become: true  # Facts gathering might need sudo for some checks
      
  tasks:
    - name: Check if running on Arch Linux
      ansible.builtin.fail:
        msg: "This playbook is designed for Arch Linux only"
      when: ansible_distribution != "Archlinux"
      
    - name: Check if yay is installed
      ansible.builtin.command: which yay
      register: yay_check
      changed_when: false
      failed_when: false
      
    - name: Install base-devel and git (required for AUR)
      ansible.builtin.pacman:
        name:
          - base-devel
          - git
        state: present
        update_cache: yes
      when: yay_check.rc != 0
      
    - name: Create AUR build user if it doesn't exist
      ansible.builtin.user:
        name: "{{ aur_user }}"
        state: present
        create_home: yes
        shell: /bin/bash
        groups: wheel
        append: yes
      when: yay_check.rc != 0
      
    - name: Install yay from AUR
      ansible.builtin.shell: |
        cd /tmp
        rm -rf yay-bin
        git clone https://aur.archlinux.org/yay-bin.git
        chown -R {{ aur_user }}:{{ aur_user }} yay-bin
      args:
        creates: /usr/bin/yay
      when: yay_check.rc != 0
      
    - name: Build yay package (as aur_user, without installing)
      ansible.builtin.shell: |
        cd /tmp/yay-bin
        makepkg -s --noconfirm
        cd ..
      become_user: "{{ aur_user }}"
      environment:
        HOME: "/home/{{ aur_user }}"
      register: yay_build
      when: yay_check.rc != 0
      
    - name: Install yay package using pacman (as root/sysadmin)
      ansible.builtin.shell: |
        cd /tmp/yay-bin
        pkg_file=$(ls *.pkg.tar.zst | head -n 1)
        pacman -U --noconfirm "$pkg_file"
        cd ..
        rm -rf yay-bin
      become: true
      when: 
        - yay_check.rc != 0
        - yay_build is defined
        - yay_build.rc == 0
      
    - name: Verify yay installation
      ansible.builtin.command: yay --version
      register: yay_version
      changed_when: false
      become: false  # No need to run as root to check version
      
    - name: Display yay version
      ansible.builtin.debug:
        msg: "yay version: {{ yay_version.stdout }}"
        
    - name: Update AUR database
      ansible.builtin.shell: yay -Sy --noconfirm
      changed_when: false
      become: false  # Run as sysadmin, not root (yay warns against root)
      
    - name: Check if Elasticsearch is installed
      ansible.builtin.shell: pacman -Q elasticsearch 2>/dev/null || pacman -Q elasticsearch-bin 2>/dev/null
      register: elasticsearch_installed
      changed_when: false
      failed_when: false
      
    - name: Display Elasticsearch installation status
      ansible.builtin.debug:
        msg: "Elasticsearch is {% if elasticsearch_installed.rc == 0 %}already installed{% else %}not installed - will install now{% endif %}"
      
    - name: Install Elasticsearch from AUR
      ansible.builtin.shell: |
        set -o pipefail
        yay -S --noconfirm --needed \
          --answerclean All --answerdiff None --answeredit None --answerupgrade All \
          elasticsearch-bin 2>&1 | tee /tmp/yay-elasticsearch.log
        exit_code=${PIPESTATUS[0]}
        if [ $exit_code -ne 0 ]; then
          echo "=========================================="
          echo "Elasticsearch installation failed with exit code: $exit_code"
          cat /tmp/yay-elasticsearch.log
          echo "=========================================="
        fi
        exit $exit_code
      # Run as sysadmin (has passwordless sudo), not root/aur_user
      become: false
      async: 3600  # 60 minutes timeout (AUR packages can take time to download/build)
      poll: 15     # Poll every 15 seconds
      register: elasticsearch_install_result
      when: elasticsearch_installed.rc != 0
      
    - name: Display Elasticsearch installation output
      ansible.builtin.debug:
        msg: "Elasticsearch installation status: {{ elasticsearch_install_result | default('skipped') }}"
      when: elasticsearch_installed.rc != 0
      
    - name: Check if Logstash is installed
      ansible.builtin.shell: pacman -Q logstash 2>/dev/null || pacman -Q logstash-bin 2>/dev/null
      register: logstash_installed
      changed_when: false
      failed_when: false
      
    - name: Install Logstash from AUR
      ansible.builtin.shell: |
        set -o pipefail
        yay -S --noconfirm --needed \
          --answerclean All --answerdiff None --answeredit None --answerupgrade All \
          logstash-bin 2>&1 | tee /tmp/yay-logstash.log
        exit_code=${PIPESTATUS[0]}
        if [ $exit_code -ne 0 ]; then
          echo "=========================================="
          echo "Logstash installation failed with exit code: $exit_code"
          cat /tmp/yay-logstash.log
          echo "=========================================="
        fi
        exit $exit_code
      # Run as sysadmin (has passwordless sudo), not root/aur_user
      become: false
      async: 3600  # 60 minutes timeout
      poll: 15     # Poll every 15 seconds
      register: logstash_install_result
      when: logstash_installed.rc != 0
      
    - name: Check if Kibana is installed
      ansible.builtin.shell: pacman -Q kibana 2>/dev/null || pacman -Q kibana-bin 2>/dev/null
      register: kibana_installed
      changed_when: false
      failed_when: false
      
    - name: Create script to fix Kibana PKGBUILD
      ansible.builtin.copy:
        content: |
          #!/bin/bash
          set -e
          cd /tmp
          rm -rf kibana-bin-fix
          git clone https://aur.archlinux.org/kibana-bin.git kibana-bin-fix
          cd kibana-bin-fix
          if grep -q "node_version_validator.js" PKGBUILD; then
            cp PKGBUILD PKGBUILD.bak
            sed -i 's/^\(.*node_version_validator\.js.*\)$/# \1/' PKGBUILD
            echo "Fixed PKGBUILD: Commented out problematic sed line"
          else
            echo "No node_version_validator.js reference found"
          fi
        dest: /tmp/fix-kibana-pkgbuild.sh
        mode: '0755'
      become: false
      when: kibana_installed.rc != 0
      
    - name: Fix Kibana PKGBUILD before installation
      ansible.builtin.command: /tmp/fix-kibana-pkgbuild.sh
      become: false
      when: kibana_installed.rc != 0
      register: kibana_pkgbuild_fix
      changed_when: false
      
    - name: Install Kibana from AUR (with fixed PKGBUILD)
      ansible.builtin.shell:
        cmd: |
          set -o pipefail
          cd /tmp/kibana-bin-fix
          makepkg -si --noconfirm 2>&1 | tee /tmp/yay-kibana.log
          exit_code=${PIPESTATUS[0]}
          if [ $exit_code -ne 0 ]; then
            echo "=========================================="
            echo "Kibana installation failed with exit code: $exit_code"
            echo "Full error log:"
            cat /tmp/yay-kibana.log
            echo "=========================================="
          fi
          cd /tmp
          rm -rf kibana-bin-fix /tmp/fix-kibana-pkgbuild.sh
          exit $exit_code
      # Run as sysadmin (has passwordless sudo), not root/aur_user
      become: false
      async: 3600  # 60 minutes timeout
      poll: 15     # Poll every 15 seconds
      register: kibana_install_result
      when: kibana_installed.rc != 0
      failed_when: false  # Don't fail playbook, we'll handle it below
      
    - name: Display Kibana installation error if failed
      ansible.builtin.debug:
        var: kibana_install_result
        verbosity: 0
      when: 
        - kibana_installed.rc != 0
        - kibana_install_result is defined
        - kibana_install_result.rc | default(0) != 0
      
    - name: Show Kibana error details
      ansible.builtin.debug:
        msg: |
          ==========================================
          Kibana installation FAILED
          ==========================================
          
          Exit Code: {{ kibana_install_result.rc | default('unknown') }}
          
          Error Output:
          {{ kibana_install_result.stderr | default('No stderr output') }}
          
          Full Output:
          {{ kibana_install_result.stdout | default('No stdout output') }}
          
          ==========================================
          This is a known issue with kibana-bin PKGBUILD version 9.2.3.
          The PKGBUILD tries to modify src/setup_node_env/node_version_validator.js
          which doesn't exist in this Kibana version.
          
          Workaround: Install Kibana manually or wait for PKGBUILD fix.
          ==========================================
      when: 
        - kibana_installed.rc != 0
        - kibana_install_result is defined
        - kibana_install_result.rc | default(0) != 0
      
    - name: Verify Elastic Stack packages are installed
      ansible.builtin.pacman:
        name: "{{ item }}"
        state: present
      register: package_check
      failed_when: false
      loop:
        - elasticsearch-bin
        - logstash-bin
        - kibana-bin
      changed_when: false
      
    - name: Display installed Elastic Stack packages
      ansible.builtin.debug:
        msg: |
          Elastic Stack installation summary:
          
          Installed packages:
          {% for item in package_check.results %}
          - {{ item.item }}: {% if item.msg is defined and 'already installed' in item.msg or 'installed' in item.msg %}installed{% else %}not found{% endif %}
          {% endfor %}
          
          Note: Kibana installation failed due to PKGBUILD bug in kibana-bin 9.2.3.
          The PKGBUILD tries to modify a file that doesn't exist in this Kibana version.
          
          Next steps:
          1. Enable services: systemctl enable --now elasticsearch logstash
          2. Configure services as needed in /etc/elasticsearch/, /etc/logstash/
          3. For Kibana: Install manually after PKGBUILD is fixed, or use a different version
# To run the playbook
